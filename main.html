<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Repair Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-color: #f0f0f0;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #start-screen, #game-screen, #end-screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #333;
            color: white;
            transition: opacity 0.5s;
        }
        
        #game-screen {
            display: none;
            opacity: 0;
        }
        
        #end-screen {
            display: none;
            opacity: 0;
        }
        
        .screen-content {
            max-width: 800px;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #ffcc00;
        }
        
        h2 {
            font-size: 2rem;
            margin-bottom: 15px;
        }
        
        p {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }
        
        button {
            padding: 12px 24px;
            font-size: 1.2rem;
            background-color: #ffcc00;
            color: #333;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #ffdd33;
        }
        
        #road {
            position: absolute;
            width: 300px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #555;
            overflow: hidden;
        }
        
        #car {
            position: absolute;
            width: 50px;
            height: 80px;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background-color: red;
            z-index: 10;
            transition: left 0.2s;
        }
        
        .pothole {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #222;
            z-index: 5;
        }
        
        .tool {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #00ccff;
            z-index: 5;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }
        
        .health {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #ff0000;
            z-index: 5;
            clip-path: polygon(
                50% 0%, 60% 30%, 90% 30%, 65% 50%, 
                75% 80%, 50% 60%, 25% 80%, 35% 50%, 
                10% 30%, 40% 30%
            );
        }
        
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 1.5rem;
            z-index: 20;
        }
        
        #health-display {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .health-icon {
            width: 20px;
            height: 20px;
            background-color: #ff0000;
            clip-path: polygon(
                50% 0%, 60% 30%, 90% 30%, 65% 50%, 
                75% 80%, 50% 60%, 25% 80%, 35% 50%, 
                10% 30%, 40% 30%
            );
        }
        
        #superpower-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: gold;
            border-radius: 50%;
            z-index: 20;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        #leaderboard {
            width: 80%;
            max-width: 600px;
            margin: 20px auto;
            border-collapse: collapse;
        }
        
        #leaderboard th, #leaderboard td {
            padding: 10px;
            border: 1px solid #ffcc00;
            text-align: center;
        }
        
        #leaderboard th {
            background-color: #ffcc00;
            color: #333;
        }
        
        #leaderboard tr:nth-child(even) {
            background-color: #444;
        }
        
        #leaderboard tr.highlight {
            background-color: #666;
            font-weight: bold;
        }
        
        .explosion {
            position: absolute;
            width: 100px;
            height: 100px;
            background-image: radial-gradient(circle, rgba(255,100,0,0.8) 0%, rgba(255,0,0,0) 70%);
            border-radius: 50%;
            z-index: 15;
            animation: explode 0.5s forwards;
        }
        
        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .grass {
            position: absolute;
            height: 100%;
            width: calc(50% - 150px);
            background-color: #2a5c2a;
        }
        
        #grass-left {
            left: 0;
        }
        
        #grass-right {
            right: 0;
        }
        
        .marker {
            position: absolute;
            height: 100%;
            width: 5px;
            background-color: #fff;
            left: calc(50% - 150px);
            z-index: 2;
        }
        
        #marker-right {
            left: calc(50% + 150px);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Start Screen -->
        <div id="start-screen">
            <div class="screen-content">
                <h1>Road Repair</h1>
                <h2>Game Instructions</h2>
                <p>Drive your car to collect tools and repair potholes on the road.</p>
                <p>Use <strong>A</strong> and <strong>D</strong> keys to move left and right.</p>
                <p>Repair potholes by driving over them when you have tools.</p>
                <p>Avoid potholes when you don't have tools or you'll lose health.</p>
                <p>Collect health packs to increase your health (max 5).</p>
                <p>You have one superpower that repairs all potholes instantly.</p>
                <p>Game lasts for 20 seconds. Try to repair as many potholes as possible!</p>
                <button id="start-btn">Start Game</button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen">
            <div id="grass-left" class="grass"></div>
            <div class="marker" id="marker-left"></div>
            <div id="road"></div>
            <div class="marker" id="marker-right"></div>
            <div id="grass-right" class="grass"></div>
            <div id="car"></div>
            
            <div id="ui">
                <div>Time: <span id="time">00:20</span></div>
                <div>Score: <span id="score">0</span></div>
                <div>Tools: <span id="tools">0</span></div>
                <div id="health-display"></div>
            </div>
            
            <div id="superpower-btn" title="Superpower (1 use)">S</div>
        </div>
        
        <!-- End Screen -->
        <div id="end-screen">
            <div class="screen-content">
                <h1>Game Over</h1>
                <h2>Your Score: <span id="final-score">0</span></h2>
                <h3>Tools Collected: <span id="final-tools">0</span></h3>
                
                <div id="username-input" style="margin: 20px 0;">
                    <input type="text" id="username" placeholder="Enter your name" maxlength="20" style="padding: 8px; font-size: 1rem;">
                    <button id="submit-score">Submit Score</button>
                </div>
                
                <h3>Leaderboard</h3>
                <table id="leaderboard">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Score</th>
                            <th>Tools</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Filled by JavaScript -->
                    </tbody>
                </table>
                
                <button id="restart-btn" style="margin-top: 30px;">Play Again</button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            screen: 'start', // start, game, end
            isRunning: false,
            isPaused: false,
            timeLeft: 20, // seconds
            score: 0,
            tools: 0,
            health: 2,
            maxHealth: 5,
            carPosition: 0, // -1 (left), 0 (center), 1 (right)
            carElement: null,
            roadElement: null,
            gameElements: [],
            superpowerUsed: false,
            gameInterval: null,
            animationFrame: null,
            lastSpawnTime: 0,
            spawnInterval: 1000, // ms
            username: '',
            leaderboard: []
        };

        // DOM elements
        const elements = {
            startScreen: document.getElementById('start-screen'),
            gameScreen: document.getElementById('game-screen'),
            endScreen: document.getElementById('end-screen'),
            startBtn: document.getElementById('start-btn'),
            restartBtn: document.getElementById('restart-btn'),
            submitScoreBtn: document.getElementById('submit-score'),
            usernameInput: document.getElementById('username'),
            timeDisplay: document.getElementById('time'),
            scoreDisplay: document.getElementById('score'),
            toolsDisplay: document.getElementById('tools'),
            finalScoreDisplay: document.getElementById('final-score'),
            finalToolsDisplay: document.getElementById('final-tools'),
            healthDisplay: document.getElementById('health-display'),
            superpowerBtn: document.getElementById('superpower-btn'),
            leaderboardBody: document.getElementById('leaderboard-body'),
            road: document.getElementById('road'),
            car: document.getElementById('car'),
            gameContainer: document.getElementById('game-container')
        };

        // Initialize game
        function initGame() {
            // Set up event listeners
            elements.startBtn.addEventListener('click', startGame);
            elements.restartBtn.addEventListener('click', restartGame);
            elements.submitScoreBtn.addEventListener('click', submitScore);
            elements.superpowerBtn.addEventListener('click', useSuperpower);
            
            document.addEventListener('keydown', handleKeyPress);
            
            // Initialize health display
            updateHealthDisplay();
        }

        // Start game
        function startGame() {
            // Reset game state
            gameState.isRunning = true;
            gameState.isPaused = false;
            gameState.timeLeft = 20;
            gameState.score = 0;
            gameState.tools = 0;
            gameState.health = 2;
            gameState.superpowerUsed = false;
            gameState.gameElements = [];
            gameState.carPosition = 0;
            
            // Update UI
            elements.scoreDisplay.textContent = gameState.score;
            elements.toolsDisplay.textContent = gameState.tools;
            updateTimeDisplay();
            updateHealthDisplay();
            
            // Show game screen
            elements.startScreen.style.display = 'none';
            elements.endScreen.style.display = 'none';
            elements.gameScreen.style.display = 'flex';
            elements.gameScreen.style.opacity = '1';
            
            // Position car
            updateCarPosition();
            
            // Start game loop
            gameState.lastSpawnTime = Date.now();
            gameState.gameInterval = setInterval(updateGame, 1000 / 60); // 60 FPS
            
            // Start timer
            gameState.timerInterval = setInterval(() => {
                if (!gameState.isPaused) {
                    gameState.timeLeft--;
                    updateTimeDisplay();
                    
                    if (gameState.timeLeft <= 0) {
                        endGame();
                    }
                }
            }, 1000);
        }

        // Update game state
        function updateGame() {
            if (gameState.isPaused || !gameState.isRunning) return;
            
            const now = Date.now();
            
            // Spawn new elements
            if (now - gameState.lastSpawnTime > gameState.spawnInterval) {
                spawnElements();
                gameState.lastSpawnTime = now;
            }
            
            // Move existing elements
            moveElements();
            
            // Check collisions
            checkCollisions();
        }

        // Spawn road elements
        function spawnElements() {
            const roadWidth = elements.road.offsetWidth;
            const types = ['pothole', 'tool', 'health'];
            
            // Determine how many elements to spawn (1-3)
            const elementCount = Math.floor(Math.random() * 3) + 1;
            
            // Ensure at least 2 elements are present (as per requirement #9)
            if (gameState.gameElements.length < 2) {
                for (let i = 0; i < 2; i++) {
                    const type = types[Math.floor(Math.random() * types.length)];
                    spawnElement(type);
                }
            } else {
                for (let i = 0; i < elementCount; i++) {
                    const type = types[Math.floor(Math.random() * types.length)];
                    spawnElement(type);
                }
            }
        }

        // Spawn a single element
        function spawnElement(type) {
            const roadWidth = elements.road.offsetWidth;
            const elementSize = type === 'pothole' ? 40 : 30;
            
            // Calculate position (ensure it's within road bounds)
            let left = Math.random() * (roadWidth - elementSize);
            
            // For potholes, ensure they don't block the entire road (requirement #9)
            if (type === 'pothole') {
                const minGap = 100; // Minimum space between pothole and road edges
                left = minGap + Math.random() * (roadWidth - elementSize - 2 * minGap);
            }
            
            // Create element
            const element = document.createElement('div');
            element.className = type;
            element.style.left = `${left}px`;
            element.style.top = `-${elementSize}px`;
            
            // Store element data
            const elementData = {
                element: element,
                type: type,
                y: -elementSize,
                speed: 3 + Math.random() * 2, // Random speed between 3-5
                width: elementSize,
                height: elementSize,
                left: left
            };
            
            elements.road.appendChild(element);
            gameState.gameElements.push(elementData);
        }

        // Move all elements down the road
        function moveElements() {
            const roadHeight = elements.road.offsetHeight;
            
            for (let i = gameState.gameElements.length - 1; i >= 0; i--) {
                const element = gameState.gameElements[i];
                
                if (!gameState.isPaused) {
                    element.y += element.speed;
                    element.element.style.top = `${element.y}px`;
                }
                
                // Remove elements that are off screen
                if (element.y > roadHeight) {
                    elements.road.removeChild(element.element);
                    gameState.gameElements.splice(i, 1);
                }
            }
        }

        // Check for collisions between car and elements
        function checkCollisions() {
            if (gameState.isPaused) return;
            
            const carRect = {
                left: elements.car.offsetLeft,
                top: elements.car.offsetTop,
                right: elements.car.offsetLeft + elements.car.offsetWidth,
                bottom: elements.car.offsetTop + elements.car.offsetHeight
            };
            
            for (let i = gameState.gameElements.length - 1; i >= 0; i--) {
                const element = gameState.gameElements[i];
                
                const elementRect = {
                    left: element.left,
                    top: element.y,
                    right: element.left + element.width,
                    bottom: element.y + element.height
                };
                
                // Check if rectangles overlap
                if (carRect.left < elementRect.right &&
                    carRect.right > elementRect.left &&
                    carRect.top < elementRect.bottom &&
                    carRect.bottom > elementRect.top) {
                    
                    // Handle collision based on element type
                    switch (element.type) {
                        case 'pothole':
                            handlePotholeCollision(element, i);
                            break;
                        case 'tool':
                            handleToolCollision(element, i);
                            break;
                        case 'health':
                            handleHealthCollision(element, i);
                            break;
                    }
                }
            }
        }

        // Handle collision with pothole
        function handlePotholeCollision(element, index) {
            if (gameState.tools > 0) {
                // Repair pothole
                gameState.tools--;
                gameState.score++;
                elements.toolsDisplay.textContent = gameState.tools;
                elements.scoreDisplay.textContent = gameState.score;
                
                // Remove pothole
                elements.road.removeChild(element.element);
                gameState.gameElements.splice(index, 1);
            } else {
                // Can't repair - lose health
                gameState.health--;
                updateHealthDisplay();
                
                // Check if game over
                if (gameState.health <= 0) {
                    createExplosion(carRect.left + carRect.width / 2, carRect.top + carRect.height / 2);
                    setTimeout(endGame, 500);
                }
            }
        }

        // Handle collision with tool
        function handleToolCollision(element, index) {
            gameState.tools++;
            elements.toolsDisplay.textContent = gameState.tools;
            
            // Remove tool
            elements.road.removeChild(element.element);
            gameState.gameElements.splice(index, 1);
        }

        // Handle collision with health
        function handleHealthCollision(element, index) {
            if (gameState.health < gameState.maxHealth) {
                gameState.health++;
                updateHealthDisplay();
                
                // Remove health pack
                elements.road.removeChild(element.element);
                gameState.gameElements.splice(index, 1);
            }
        }

        // Create explosion animation
        function createExplosion(x, y) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = `${x - 50}px`;
            explosion.style.top = `${y - 50}px`;
            
            elements.gameContainer.appendChild(explosion);
            
            // Remove after animation
            setTimeout(() => {
                elements.gameContainer.removeChild(explosion);
            }, 500);
        }

        // Use superpower
        function useSuperpower() {
            if (gameState.superpowerUsed || !gameState.isRunning || gameState.isPaused) return;
            
            gameState.superpowerUsed = true;
            elements.superpowerBtn.style.display = 'none';
            
            // Count potholes to repair
            let potholesRepaired = 0;
            
            for (let i = gameState.gameElements.length - 1; i >= 0; i--) {
                const element = gameState.gameElements[i];
                
                if (element.type === 'pothole') {
                    potholesRepaired++;
                    
                    // Remove pothole
                    elements.road.removeChild(element.element);
                    gameState.gameElements.splice(i, 1);
                }
            }
            
            // Update score
            gameState.score += potholesRepaired;
            elements.scoreDisplay.textContent = gameState.score;
        }

        // Update car position based on gameState.carPosition
        function updateCarPosition() {
            const roadRect = elements.road.getBoundingClientRect();
            const carWidth = elements.car.offsetWidth;
            
            let leftPosition;
            
            switch (gameState.carPosition) {
                case -1: // Left lane
                    leftPosition = roadRect.left - (carWidth / 2);
                    break;
                case 0: // Center lane
                    leftPosition = roadRect.left + (roadRect.width / 2) - (carWidth / 2);
                    break;
                case 1: // Right lane
                    leftPosition = roadRect.left + roadRect.width - (carWidth / 2);
                    break;
            }
            
            elements.car.style.left = `${leftPosition}px`;
        }

        // Handle keyboard input
        function handleKeyPress(e) {
            if (!gameState.isRunning || gameState.isPaused) return;
            
            switch (e.key.toLowerCase()) {
                case 'a':
                    if (gameState.carPosition > -1) {
                        gameState.carPosition--;
                        updateCarPosition();
                    }
                    break;
                case 'd':
                    if (gameState.carPosition < 1) {
                        gameState.carPosition++;
                        updateCarPosition();
                    }
                    break;
                case 'pause': // Pause game (key code 19)
                case 'p':
                    togglePause();
                    break;
            }
        }

        // Toggle pause state
        function togglePause() {
            gameState.isPaused = !gameState.isPaused;
            
            if (gameState.isPaused) {
                // Show pause overlay or indicator
            } else {
                // Hide pause overlay
            }
        }

        // Update time display
        function updateTimeDisplay() {
            const minutes = Math.floor(gameState.timeLeft / 60);
            const seconds = gameState.timeLeft % 60;
            elements.timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Update health display
        function updateHealthDisplay() {
            elements.healthDisplay.innerHTML = '';
            
            for (let i = 0; i < gameState.health; i++) {
                const healthIcon = document.createElement('div');
                healthIcon.className = 'health-icon';
                elements.healthDisplay.appendChild(healthIcon);
            }
        }

        // End game
        function endGame() {
            gameState.isRunning = false;
            
            // Clear intervals
            clearInterval(gameState.gameInterval);
            clearInterval(gameState.timerInterval);
            
            // Update final score display
            elements.finalScoreDisplay.textContent = gameState.score;
            elements.finalToolsDisplay.textContent = gameState.tools;
            
            // Show end screen
            elements.gameScreen.style.opacity = '0';
            setTimeout(() => {
                elements.gameScreen.style.display = 'none';
                elements.endScreen.style.display = 'flex';
                setTimeout(() => {
                    elements.endScreen.style.opacity = '1';
                }, 10);
            }, 500);
            
            // Clear game elements
            gameState.gameElements.forEach(element => {
                if (element.element.parentNode) {
                    elements.road.removeChild(element.element);
                }
            });
            gameState.gameElements = [];
        }

        // Restart game
        function restartGame() {
            elements.endScreen.style.opacity = '0';
            setTimeout(() => {
                elements.endScreen.style.display = 'none';
                startGame();
            }, 500);
        }

        // Submit score to server
        function submitScore() {
            gameState.username = elements.usernameInput.value.trim();
            
            if (!gameState.username) {
                alert('Please enter your name');
                return;
            }
            
            // Prepare data for submission
            const data = {
                username: gameState.username,
                score: gameState.score,
                toolkit: gameState.tools
            };
            
            // In a real implementation, you would send this to your PHP server
            console.log('Submitting score:', data);
            
            // For demonstration, we'll simulate a response
            simulateServerResponse(data);
        }

        // Simulate server response (replace with actual AJAX call)
        function simulateServerResponse(data) {
            // This is where you would make the actual AJAX call to your PHP file
            // For now, we'll simulate a response with some dummy data
            
            setTimeout(() => {
                // Simulated response data
                const response = [
                    {"id":"1","username":"Player1","score":"150","toolkit":"12"},
                    {"id":"2","username":"Player2","score":"120","toolkit":"10"},
                    {"id":"3","username":"Player3","score":"100","toolkit":"8"},
                    {"id":"4","username":data.username,"score":data.score.toString(),"toolkit":data.toolkit.toString()},
                    {"id":"5","username":"Player4","score":"80","toolkit":"7"},
                    {"id":"6","username":"Player5","score":"60","toolkit":"5"}
                ];
                
                // Process the response and update leaderboard
                updateLeaderboard(response, data.username);
                
                // Hide username input
                elements.usernameInput.style.display = 'none';
                elements.submitScoreBtn.style.display = 'none';
            }, 500);
        }

        // Update leaderboard with data from server
        function updateLeaderboard(data, currentUsername) {
            // Sort by score descending
            data.sort((a, b) => parseInt(b.score) - parseInt(a.score));
            
            // Clear existing leaderboard
            elements.leaderboardBody.innerHTML = '';
            
            // Add rows to leaderboard
            let currentRank = 1;
            let prevScore = null;
            
            for (let i = 0; i < data.length; i++) {
                const player = data[i];
                const playerScore = parseInt(player.score);
                
                // Determine rank (account for ties)
                if (prevScore !== null && playerScore !== prevScore) {
                    currentRank = i + 1;
                }
                prevScore = playerScore;
                
                // Create row
                const row = document.createElement('tr');
                
                // Highlight current player
                if (player.username === currentUsername) {
                    row.classList.add('highlight');
                }
                
                row.innerHTML = `
                    <td>${currentRank}</td>
                    <td>${player.username}</td>
                    <td>${player.score}</td>
                    <td>${player.toolkit}</td>
                `;
                
                elements.leaderboardBody.appendChild(row);
            }
        }

        // Initialize the game when the page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>